<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–∏ —Å–µ—Ä–≤–µ—Ä—ã ‚Äî LodoMonitoring</title>
    <link rel="stylesheet" href="css/style.css">
    <script type="importmap">
        {
            "imports": {
                "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"
            }
        }
    </script>
</head>
<body>
    <header>
        <div class="logo">
            <img src="images/logo.png" alt="LodoMonitoring" width="40">
            <h1>LodoMonitoring</h1>
        </div>
        <nav>
            <a href="index.html">–ì–ª–∞–≤–Ω–∞—è</a>
            <a href="dashboard.html">–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</a>
            <span id="auth-section"></span>
        </nav>
    </header>

    <main>
        <h2>üë§ –ú–æ–∏ —Å–µ—Ä–≤–µ—Ä—ã</h2>
        <div id="myServersList" class="server-grid"></div>
        <div id="noServers" style="text-align: center; margin-top: 2rem; color: #b0e0e6; display: none;">
            <p>–í—ã –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–∏–ª–∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞.</p>
            <a href="dashboard.html" class="btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</a>
        </div>
    </main>

    <script type="module">
        import { auth } from './js/firebase-config.js';
        import { getServers, deleteServer } from './js/servers.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { renderServerCard } from './js/main.js';

        const container = document.getElementById('myServersList');
        const noServersDiv = document.getElementById('noServers');

        onAuthStateChanged(auth, async (user) => {
            if (!user) {
                window.location.href = 'login.html';
                return;
            }

            // –ü–æ–ª—É—á–∞–µ–º —Å–µ—Ä–≤–µ—Ä—ã —Ç–æ–ª—å–∫–æ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const servers = await getServers(user.uid);
            
            if (servers.length === 0) {
                container.innerHTML = '';
                noServersDiv.style.display = 'block';
                return;
            }

            noServersDiv.style.display = 'none';
            container.innerHTML = '';

            servers.forEach(server => {
                const card = renderServerCard(server);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è (—Ç–æ–ª—å–∫–æ –¥–ª—è –≤–ª–∞–¥–µ–ª—å—Ü–∞)
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-small';
                deleteBtn.style.backgroundColor = '#c62828';
                deleteBtn.textContent = '–£–¥–∞–ª–∏—Ç—å';
                deleteBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    if (!confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä?')) return;
                    try {
                        await deleteServer(server.id, server.ownerId);
                        card.remove(); // —É–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Å—Ç–∞–ª–∏—Å—å –ª–∏ —Å–µ—Ä–≤–µ—Ä—ã
                        if (container.children.length === 0) {
                            noServersDiv.style.display = 'block';
                        }
                    } catch (err) {
                        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: ' + err.message);
                    }
                });

                // –ö–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–∑–∞–≥–ª—É—à–∫–∞, –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–æ–∑–∂–µ)
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-small';
                editBtn.style.backgroundColor = '#ffa726';
                editBtn.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å';
                editBtn.addEventListener('click', () => {
                    window.location.href = `edit-server.html?id=${server.id}`;
                });

                const actionsDiv = document.createElement('div');
                actionsDiv.style.display = 'flex';
                actionsDiv.style.gap = '0.5rem';
                actionsDiv.style.marginTop = '0.8rem';
                actionsDiv.appendChild(editBtn);
                actionsDiv.appendChild(deleteBtn);

                card.querySelector('.server-meta').after(actionsDiv); // –≤—Å—Ç–∞–≤–∏—Ç—å –ø–æ—Å–ª–µ meta
                container.appendChild(card);
            });
        });
    </script>
</body>
</html>
